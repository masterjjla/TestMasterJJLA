{"version":3,"file":"snap.js","sourceRoot":"","sources":["../../src/targets/snap.ts"],"names":[],"mappings":"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","sourcesContent":["import { Arch, debug, exec, log, replaceDefault, spawn, toLinuxArchString, serializeToYaml } from \"builder-util\"\nimport { copyFile } from \"builder-util/out/fs\"\nimport { emptyDir, outputFile } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport { Target } from \"../core\"\nimport { LinuxPackager } from \"../linuxPackager\"\nimport { SnapOptions } from \"../options/SnapOptions\"\nimport { LinuxTargetHelper } from \"./LinuxTargetHelper\"\nimport { RemoteBuilder } from \"./RemoteBuilder\"\n\nexport default class SnapTarget extends Target {\n  readonly options: SnapOptions = {...this.packager.platformSpecificBuildOptions, ...(this.packager.config as any)[this.name]}\n\n  constructor(name: string, private readonly packager: LinuxPackager, private readonly helper: LinuxTargetHelper, readonly outDir: string) {\n    super(name)\n  }\n\n  async build(appOutDir: string, arch: Arch): Promise<any> {\n    log(`Building Snap for arch ${Arch[arch]}`)\n\n    if (process.platform === \"win32\" || process.env._REMOTE_BUILD) {\n      const remoteBuilder = new RemoteBuilder()\n      return await remoteBuilder.build([\"snap\"], appOutDir, this.packager, this.outDir)\n    }\n\n    const packager = this.packager\n    const appInfo = packager.appInfo\n    const options = this.options\n\n    const stageDir = `${appOutDir}-snap`\n    // snapcraft.yaml inside a snap directory\n    const snapDir = path.join(stageDir, \"snap\")\n    await emptyDir(stageDir)\n\n    const snap: any = {}\n    snap.name = packager.executableName.toLowerCase()\n    snap.version = appInfo.version\n    snap.summary = options.summary || appInfo.productName\n    snap.description = this.helper.getDescription(options)\n    snap.confinement = options.confinement || \"strict\"\n    snap.grade = options.grade || \"stable\"\n\n    await this.helper.icons\n    if (this.helper.maxIconPath != null) {\n      snap.icon = \"snap/gui/icon.png\"\n      await copyFile(this.helper.maxIconPath, path.join(snapDir, \"gui\", \"icon.png\"))\n    }\n\n    const desktopFile = await this.helper.writeDesktopEntry(this.options, packager.executableName, path.join(snapDir, \"gui\", `${snap.name}.desktop`), {\n      // tslint:disable:no-invalid-template-strings\n      Icon: \"${SNAP}/meta/gui/icon.png\"\n    })\n\n    if (options.assumes != null) {\n      if (!Array.isArray(options.assumes)) {\n        throw new Error(\"snap.assumes must be an array of strings\")\n      }\n      snap.assumes = options.assumes\n    }\n\n    snap.apps = {\n      [snap.name]: {\n        command: `env TMPDIR=$XDG_RUNTIME_DIR desktop-launch $SNAP/${packager.executableName}`,\n        plugs: replaceDefault(options.plugs, [\"home\", \"x11\", \"unity7\", \"browser-support\", \"network\", \"gsettings\", \"pulseaudio\", \"opengl\"])\n      }\n    }\n\n    let isUseDocker = process.platform !== \"linux\"\n    if (process.platform === \"darwin\" && process.env.USE_SYSTEM_SNAPCAFT) {\n      try {\n        // http://click.pocoo.org/5/python3/\n        const env: any = {...process.env}\n        delete env.VERSIONER_PYTHON_VERSION\n        delete env.VERSIONER_PYTHON_PREFER_32_BIT\n        await exec(\"snapcraft\", [\"--version\"], {\n          // execution because Python 3 was configured to use ASCII as encoding for the environment\n          env,\n        })\n        isUseDocker = false\n      }\n      catch (e) {\n        debug(`snapcraft not installed: ${e}`)\n      }\n    }\n\n    // libxss1, libasound2, gconf2 - was \"error while loading shared libraries: libXss.so.1\" on Xubuntu 16.04\n    const defaultStagePackages = [\"libnotify4\", \"libappindicator1\", \"libxtst6\", \"libnss3\", \"libxss1\", \"fontconfig-config\", \"gconf2\", \"libasound2\", \"pulseaudio\"]\n    const defaultAfter = [\"desktop-glib-only\"]\n    const after = replaceDefault(options.after, defaultAfter)\n    snap.parts = {\n      app: {\n        plugin: \"dump\",\n        \"stage-packages\": replaceDefault(options.stagePackages, defaultStagePackages),\n        source: isUseDocker ? `/out/${path.basename(appOutDir)}` : appOutDir,\n        after\n      }\n    }\n\n    const stagePackages = replaceDefault(options.stagePackages, defaultStagePackages)\n    if (stagePackages.length > 0) {\n      snap.parts.app[\"stage-packages\"] = stagePackages\n    }\n\n    if (packager.packagerOptions.effectiveOptionComputed != null && await packager.packagerOptions.effectiveOptionComputed({snap, desktopFile})) {\n      return\n    }\n\n    const snapcraftFile = path.join(snapDir, \"snapcraft.yaml\")\n    await outputFile(snapcraftFile, serializeToYaml(snap))\n\n    const snapFileName = `${snap.name}_${snap.version}_${toLinuxArchString(arch)}.snap`\n    const resultFile = path.join(this.outDir, snapFileName)\n\n    // usr/share/fonts is required, cannot run otherwise\n    const unnecessaryFiles = [\n      \"usr/share/doc\",\n      \"usr/share/man\",\n      \"usr/share/icons\",\n      \"usr/share/bash-completion\",\n      \"usr/share/lintian\",\n      \"usr/share/dh-python\",\n      \"usr/share/python3\",\n\n      \"usr/lib/python*\",\n      \"usr/bin/python*\",\n    ]\n\n    if (isUseDocker) {\n      const commands: Array<string> = []\n      if (options.buildPackages != null && options.buildPackages.length > 0) {\n        commands.push(`apt-get update && apt-get install -y ${options.buildPackages.join(\" \")}`)\n      }\n\n      // https://bugs.launchpad.net/snapcraft/+bug/1692752\n      commands.push(`cp -R /out/${path.basename(stageDir)} /s/`)\n      commands.push(\"cd /s\")\n      commands.push(\"apt-get -qq update\")\n      commands.push(`snapcraft prime --target-arch ${toLinuxArchString(arch)}`)\n      commands.push(`rm -rf ${unnecessaryFiles.map(it => `prime/${it}`).join(\" \")}`)\n      commands.push(`snapcraft snap --target-arch ${toLinuxArchString(arch)} -o /out/${snapFileName}`)\n\n      await spawn(\"docker\", [\"run\", \"--rm\",\n        \"-v\", `${packager.info.projectDir}:/project`,\n        // dist dir can be outside of project dir\n        \"-v\", `${this.outDir}:/out`,\n        \"electronuserland/builder:latest\",\n        \"/bin/bash\", \"-c\", commands.join(\" && \")], {\n        cwd: packager.info.projectDir,\n        stdio: [\"ignore\", \"inherit\", \"inherit\"],\n      })\n    }\n    else {\n      if (options.buildPackages != null && options.buildPackages.length > 0) {\n        await spawn(\"apt-get\", [\"-qq\", \"update\"])\n        await spawn(\"apt-get\", [\"-qq\", \"install\", \"--no-install-recommends\"].concat(options.buildPackages))\n      }\n      const spawnOptions = {\n        cwd: stageDir,\n        stdio: [\"ignore\", \"inherit\", \"inherit\"],\n      }\n      await spawn(\"snapcraft\", [\"prime\", \"--target-arch\", toLinuxArchString(arch)], spawnOptions)\n      await exec(\"sh\", [\"-c\", `rm -rf ${unnecessaryFiles.join(\" \")}`], {\n        cwd: stageDir + path.sep + \"prime\",\n      })\n      await spawn(\"snapcraft\", [\"snap\", \"--target-arch\", toLinuxArchString(arch), \"-o\", resultFile], spawnOptions)\n    }\n    packager.dispatchArtifactCreated(resultFile, this, arch)\n  }\n}\n"]}
